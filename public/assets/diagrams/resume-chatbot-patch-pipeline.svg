<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 640" role="img" aria-label="Streaming JSON Patch Pipeline Diagram">
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="var(--color-base-content, #1a1a1a)"/>
    </marker>
    <marker id="arrowhead-dashed" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="var(--color-base-content, #1a1a1a)"/>
    </marker>
    <filter id="shadow" x="0" y="0" width="120%" height="120%">
      <feDropShadow dx="3" dy="3" stdDeviation="0" flood-color="rgba(0,0,0,0.2)"/>
    </filter>
    <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
      <feGaussianBlur stdDeviation="2" result="blur"/>
      <feMerge>
        <feMergeNode in="blur"/>
        <feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  </defs>
  <style>
    :root {
      --diagram-bg: var(--color-base-200, #f0f0f0);
      --diagram-border: var(--color-base-content, #1a1a1a);
      --diagram-text: currentColor;
      --diagram-accent: var(--color-primary, #00bcd4);
      --diagram-secondary: var(--color-secondary, #50fa7b);
      --diagram-accent2: var(--color-accent, #ff0080);
      --diagram-muted: var(--color-base-300, #d0d0d0);
      --diagram-warning: var(--color-warning, #f97316);
    }
    .bg-box { fill: var(--diagram-bg); stroke: var(--diagram-border); stroke-width: 3; }
    .step-box { fill: var(--diagram-bg); stroke: var(--diagram-border); stroke-width: 2.5; }
    .accent-box { fill: var(--diagram-accent); stroke: var(--diagram-border); stroke-width: 2; }
    .secondary-box { fill: var(--diagram-secondary); stroke: var(--diagram-border); stroke-width: 2; }
    .accent2-box { fill: var(--diagram-accent2); stroke: var(--diagram-border); stroke-width: 2; }
    .muted-box { fill: var(--diagram-muted); stroke: var(--diagram-border); stroke-width: 2; }
    .warning-box { fill: var(--diagram-warning); stroke: var(--diagram-border); stroke-width: 2; }
    .text { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; fill: var(--diagram-text); }
    .text-sm { font-size: 10px; }
    .text-md { font-size: 12px; }
    .text-lg { font-size: 14px; font-weight: 600; }
    .text-title { font-size: 16px; font-weight: 700; }
    .code-text { font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace; font-size: 9px; }
    .arrow { stroke: var(--diagram-border); stroke-width: 2.5; marker-end: url(#arrowhead); fill: none; }
    .dashed-arrow { stroke: var(--diagram-border); stroke-width: 2; stroke-dasharray: 6,4; marker-end: url(#arrowhead-dashed); fill: none; }
    .highlight-box { fill: rgba(0, 188, 212, 0.15); stroke: var(--diagram-accent); stroke-width: 2; stroke-dasharray: 4,3; }
  </style>
  
  <!-- Background -->
  <rect x="0" y="0" width="900" height="640" fill="transparent"/>
  
  <!-- Title -->
  <text x="450" y="30" class="text text-title" text-anchor="middle">Streaming JSON Patch Pipeline</text>
  <text x="450" y="48" class="text text-md" text-anchor="middle" opacity="0.7">From User Request to UI Update</text>
  
  <!-- User Input -->
  <g transform="translate(50, 70)">
    <rect x="0" y="0" width="800" height="50" class="accent-box" rx="8" filter="url(#shadow)"/>
    <text x="400" y="22" class="text text-lg" text-anchor="middle">User Request</text>
    <text x="400" y="40" class="text text-md" text-anchor="middle" font-style="italic">"Add Python to my skills"</text>
  </g>
  
  <!-- Arrow down -->
  <line x1="450" y1="120" x2="450" y2="145" class="arrow"/>
  
  <!-- Chat Model Decision -->
  <g transform="translate(50, 155)">
    <rect x="0" y="0" width="800" height="65" class="secondary-box" rx="8" filter="url(#shadow)"/>
    <text x="400" y="25" class="text text-lg" text-anchor="middle">Chat Model Decides to Call Tool</text>
    <text x="400" y="45" class="text text-md" text-anchor="middle">Recognizes intent → Selects patchResume tool → Prepares tool call</text>
  </g>
  
  <!-- Arrow down -->
  <line x1="450" y1="220" x2="450" y2="245" class="arrow"/>
  
  <!-- Patch Model Generation (highlighted section) -->
  <g transform="translate(30, 255)">
    <rect x="0" y="0" width="840" height="180" class="highlight-box" rx="12"/>
    <text x="420" y="25" class="text text-title" text-anchor="middle">Patch Model (gpt-4.1-mini) Generates Structured Output</text>
    
    <!-- Code block visualization -->
    <g transform="translate(20, 40)">
      <rect x="0" y="0" width="460" height="125" class="muted-box" rx="6"/>
      <text x="230" y="22" class="text text-md" text-anchor="middle" font-weight="600">Structured Output (Zod Schema)</text>
      <text x="15" y="45" class="text code-text">{</text>
      <text x="30" y="60" class="text code-text">"changes": "Add Python to Languages skill",</text>
      <text x="30" y="75" class="text code-text">"patches": [</text>
      <text x="45" y="90" class="text code-text">{ "op": "add", "path": "/skills/0/keywords/-",</text>
      <text x="45" y="105" class="text code-text">  "value": "Python" }</text>
      <text x="30" y="120" class="text code-text">]</text>
      <text x="15" y="135" class="text code-text">}</text>
    </g>
    
    <!-- Explanation -->
    <g transform="translate(500, 40)">
      <rect x="0" y="0" width="320" height="125" class="bg-box" rx="6"/>
      <text x="160" y="22" class="text text-md" text-anchor="middle" font-weight="600">RFC 6902 JSON Patch</text>
      <text x="20" y="45" class="text text-sm">• op: Operation type (add/replace/remove)</text>
      <text x="20" y="62" class="text text-sm">• path: JSON Pointer to target location</text>
      <text x="20" y="79" class="text text-sm">• value: New value to apply</text>
      <text x="20" y="96" class="text text-sm">• "-" means append to array</text>
      <text x="20" y="113" class="text text-sm">• Atomic, reversible operations</text>
    </g>
  </g>
  
  <!-- Arrow down -->
  <line x1="450" y1="435" x2="450" y2="455" class="arrow"/>
  
  <!-- Streaming Flow (horizontal) -->
  <g transform="translate(20, 465)">
    <text x="430" y="15" class="text text-md" text-anchor="middle" font-weight="600">Streaming Pipeline — Each Step Emits Tokens as They Arrive</text>
    
    <!-- Step 1: partialObjectStream -->
    <g transform="translate(0, 30)">
      <rect x="0" y="0" width="160" height="100" class="accent-box" rx="6" filter="url(#shadow)"/>
      <text x="80" y="25" class="text text-md" text-anchor="middle" font-weight="600">partialObject</text>
      <text x="80" y="42" class="text text-md" text-anchor="middle" font-weight="600">Stream</text>
      <text x="80" y="62" class="text text-sm" text-anchor="middle">Vercel AI SDK</text>
      <text x="80" y="78" class="text text-sm" text-anchor="middle">Emits partial JSON</text>
      <text x="80" y="92" class="text text-sm" text-anchor="middle">as tokens stream</text>
    </g>
    
    <!-- Arrow right -->
    <line x1="160" y1="80" x2="190" y2="80" class="arrow"/>
    
    <!-- Step 2: Path Stabilization -->
    <g transform="translate(190, 30)">
      <rect x="0" y="0" width="160" height="100" class="warning-box" rx="6" filter="url(#shadow)"/>
      <text x="80" y="25" class="text text-md" text-anchor="middle" font-weight="600">Path</text>
      <text x="80" y="42" class="text text-md" text-anchor="middle" font-weight="600">Stabilization</text>
      <text x="80" y="62" class="text text-sm" text-anchor="middle">Filter waits for</text>
      <text x="80" y="78" class="text text-sm" text-anchor="middle">complete JSON</text>
      <text x="80" y="92" class="text text-sm" text-anchor="middle">paths before applying</text>
    </g>
    
    <!-- Arrow right -->
    <line x1="350" y1="80" x2="380" y2="80" class="arrow"/>
    
    <!-- Step 3: fast-json-patch -->
    <g transform="translate(380, 30)">
      <rect x="0" y="0" width="160" height="100" class="secondary-box" rx="6" filter="url(#shadow)"/>
      <text x="80" y="25" class="text text-md" text-anchor="middle" font-weight="600">fast-json-</text>
      <text x="80" y="42" class="text text-md" text-anchor="middle" font-weight="600">patch</text>
      <text x="80" y="62" class="text text-sm" text-anchor="middle">Validates RFC 6902</text>
      <text x="80" y="78" class="text text-sm" text-anchor="middle">Applies operation</text>
      <text x="80" y="92" class="text text-sm" text-anchor="middle">to document</text>
    </g>
    
    <!-- Arrow right -->
    <line x1="540" y1="80" x2="570" y2="80" class="arrow"/>
    
    <!-- Step 4: DataStream -->
    <g transform="translate(570, 30)">
      <rect x="0" y="0" width="160" height="100" class="accent2-box" rx="6" filter="url(#shadow)"/>
      <text x="80" y="25" class="text text-md" text-anchor="middle" font-weight="600">DataStream</text>
      <text x="80" y="42" class="text text-md" text-anchor="middle" font-weight="600">(SSE)</text>
      <text x="80" y="62" class="text text-sm" text-anchor="middle">Sends delta to</text>
      <text x="80" y="78" class="text text-sm" text-anchor="middle">client via</text>
      <text x="80" y="92" class="text text-sm" text-anchor="middle">Server-Sent Events</text>
    </g>
    
    <!-- Arrow right -->
    <line x1="730" y1="80" x2="760" y2="80" class="arrow"/>
    
    <!-- Step 5: React Re-render -->
    <g transform="translate(760, 30)">
      <rect x="0" y="0" width="120" height="100" class="bg-box" rx="6" filter="url(#shadow)"/>
      <text x="60" y="25" class="text text-md" text-anchor="middle" font-weight="600">React</text>
      <text x="60" y="42" class="text text-md" text-anchor="middle" font-weight="600">Re-render</text>
      <text x="60" y="62" class="text text-sm" text-anchor="middle">Only affected</text>
      <text x="60" y="78" class="text text-sm" text-anchor="middle">section</text>
      <text x="60" y="92" class="text text-sm" text-anchor="middle">updates</text>
    </g>
  </g>
  
  <!-- Final arrow down to scroll-to-edit -->
  <line x1="840" y1="595" x2="840" y2="610" class="arrow"/>
  
  <!-- Final Step: Scroll-to-edit -->
  <g transform="translate(350, 615)">
    <rect x="0" y="0" width="200" height="25" class="muted-box" rx="4"/>
    <text x="100" y="17" class="text text-sm" text-anchor="middle">Scroll-to-edit highlights the change</text>
  </g>
</svg>