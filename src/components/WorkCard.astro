---
import type { CollectionEntry } from "astro:content";
import type { ImageMetadata } from "astro";
import { Image, getImage } from "astro:assets";
import ArticleOutline from "./ArticleOutline.astro";
import TechHero from "./TechHero.astro";

export interface Props {
	entry: CollectionEntry<"work">;
	mode?: "card" | "expanded";
}

const { entry, mode = "card" } = Astro.props;

// Extract data from entry
const {
	title,
	company,
	image: rawImage,
	category,
	impact,
	stack = [],
	tags = [],
	roleCategory,
	startDate,
	endDate,
	techBrand,
	heroFeature,
} = entry.data;

// Cast image to correct type for Image component
const image = rawImage as ImageMetadata | undefined;

const slug = entry.slug;

// Generate full-size image URL for preloading on hover (detail page uses 1024px)
const preloadImage = image && mode === "card" ? await getImage({
	src: image,
	width: 1024,
	format: "webp",
	quality: 85,
}) : null;

// Render markdown content if in expanded mode
const { Content } =
	mode === "expanded" ? await entry.render() : { Content: null };

// Define color schemes for different categories
const getCategoryColor = (cat: string | undefined) => {
	switch (cat) {
		case "HEADLESS CMS":
			return "badge-primary";
		case "WEB PLATFORMS":
			return "badge-primary";
		case "MARKETING AUTOMATION":
			return "badge-accent";
		case "AUTOMATION & AI":
			return "badge-warning";
		case "AI APPLICATION":
			return "badge-info";
		case "CHROME EXTENSIONS":
			return "badge-info";
		case "SYSTEMS":
			return "badge-success";
		default:
			return "badge-outline";
	}
};

const getStackColor = (tech: string) => {
	const lowerTech = tech.toLowerCase();
	if (lowerTech.includes("astro") || lowerTech.includes("datocms"))
		return "badge-primary";
	if (lowerTech.includes("n8n") || lowerTech.includes("windmill"))
		return "badge-warning";
	if (lowerTech.includes("chrome") || lowerTech.includes("openai"))
		return "badge-info";
	if (lowerTech.includes("langchain")) return "badge-success";
	if (tech.includes("+")) return "badge-success";
	return "badge-outline";
};

// Format date range nicely
const formatDate = (date: Date) => date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
const dateRange = `${formatDate(startDate)} â€“ ${endDate ? formatDate(endDate) : 'Present'}`;
---

<!-- Card Mode -->
<!-- 
  JIT View Transition Pattern:
  - No static transition:name on card mode elements
  - Names are applied dynamically via JS only to the clicked card (forward nav)
  - Or injected on the target card during astro:after-swap (back nav)
  - This prevents 20+ simultaneous transition groups from overloading the browser
-->
{mode === "card" && (
  <div
    class="card bg-base-100 border-2 border-base-300 overflow-hidden relative mb-4 sm:mb-12 h-full shadow-xs"
    data-work-card={true}
    data-category={category}
    data-card-id={slug}
    data-scroll-target={true}
    data-preload-image={preloadImage?.src}
    data-vt-card="work-card"
  >
    <a 
      href={`/work/${slug}`}
      class="absolute inset-0 z-10"
      aria-label={`View ${title} project details`}
      data-astro-prefetch
    />
    
    <figure data-vt-img="work-img" class="relative w-full h-36 sm:h-48 overflow-hidden">
      {techBrand && heroFeature ? (
        <!-- Use TechHero for branded tech projects -->
        <TechHero tech={techBrand} feature={heroFeature} variant="compact" />
      ) : image ? (
        <!-- Use Image for projects with custom images -->
        <Image
          src={image}
          alt={title}
          class="h-full w-full z-0 object-cover"
          widths={[300, 400]}
          sizes="(max-width: 640px) 300px, 400px"
          format="webp"
          loading="lazy"
          quality={75}
        />
      ) : (
        <!-- Fallback placeholder -->
        <div class="h-full w-full bg-base-300 flex items-center justify-center">
          <span class="text-base-content/50 text-sm">No image</span>
        </div>
      )}
      {category && (
        <div class="absolute top-2 left-2 z-20">
          <span class={`badge ${getCategoryColor(category)} font-bold uppercase badge-sm`}>
            {category}
          </span>
        </div>
      )}
    </figure>
    
    <div data-vt-body="work-body" class="card-body p-2 sm:p-6 gap-1 items-start text-left flex flex-col">
      <h2 data-vt-title="work-title" class="card-title text-sm sm:text-lg leading-tight w-full mb-0.5">
        {title}
      </h2>
      
      {impact && (
        <div data-vt-impact="work-impact" class="w-full min-h-[28px] sm:min-h-[36px]">
          <p class="font-bold text-primary uppercase leading-tight text-[10px] sm:text-xs line-clamp-2">
            {impact}
          </p>
        </div>
      )}
      
      {tags.length > 0 && (
        <div class="card-actions w-full mt-auto pt-2 sm:pt-3 border-t border-base-200/50">
          <div class="flex flex-wrap gap-1 sm:gap-2">
            {tags.slice(0, 3).map((tag) => (
              <span class="badge badge-outline text-[9px] sm:text-xs px-1.5 sm:px-2 py-0.5 h-auto min-h-0">
                {tag}
              </span>
            ))}
          </div>
        </div>
      )}
    </div>
  </div>
)}

<!-- Expanded Mode - Redesigned -->
{mode === "expanded" && (
  <article class="max-w-6xl mx-auto" transition:name="work-card">
    <!-- Hero Section -->
    <header class="mb-4 sm:mb-8">
      <!-- Hero Image -->
      <figure transition:name="work-img" class="relative w-full h-48 sm:h-64 lg:h-80 rounded-none sm:rounded-xl overflow-hidden mb-4 sm:mb-6 border-y-2 border-x-0 sm:border-2 border-base-300">
        {techBrand && heroFeature ? (
          <!-- Use TechHero for branded tech projects -->
          <TechHero tech={techBrand} feature={heroFeature} variant="full" />
        ) : image ? (
          <Image
            src={image}
            alt={title}
            class="h-full w-full object-cover"
            widths={[600, 900, 1024]}
            sizes="(max-width: 640px) 600px, (max-width: 1024px) 900px, 1024px"
            format="webp"
            loading="eager"
            quality={85}
          />
        ) : (
          <div class="h-full w-full bg-base-300 flex items-center justify-center">
            <span class="text-base-content/50">No image</span>
          </div>
        )}
        {category && (
          <div class="absolute top-4 left-4">
            <span class={`badge ${getCategoryColor(category)} font-bold uppercase badge-lg shadow-lg`}>
              {category}
            </span>
          </div>
        )}
      </figure>
      
      <!-- Title & Meta -->
      <div transition:name="work-body" class="px-4 sm:px-0">
        <h1 transition:name="work-title" class="text-3xl sm:text-4xl lg:text-5xl font-black mb-4 leading-tight">
          {title}
        </h1>
        
        <!-- Meta Bar -->
        <div class="flex flex-wrap items-center gap-4 text-sm text-base-content/70 mb-4">
          {company && (
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
              </svg>
              <span class="font-medium">{company}</span>
            </div>
          )}
          {roleCategory && (
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
              <span class="font-medium">{roleCategory}</span>
            </div>
          )}
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <span>{dateRange}</span>
          </div>
        </div>
        
        <!-- Impact Statement -->
        {impact && (
          <div transition:name="work-impact" class="bg-primary/10 border-l-4 border-primary px-4 py-3 rounded-r-lg">
            <p class="font-bold text-primary text-lg leading-snug">
              {impact}
            </p>
          </div>
        )}
      </div>
    </header>
    
    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
      <!-- Main Content Column -->
      <div class="lg:col-span-3">
        {Content && (
          <div class="solid-bg rounded-none sm:rounded-xl border-y-2 border-x-0 sm:border-2 border-base-300 p-4 sm:p-6 shadow-sm">
            <div class="prose-content">
              <Content />
            </div>
          </div>
        )}
      </div>
      
      <!-- Sidebar -->
      <aside class="lg:col-span-1">
        <div class="lg:sticky lg:top-24">
          <!-- Technology Stack -->
          {stack && stack.length > 0 && (
            <section class="solid-bg p-4 sm:p-5 rounded-none sm:rounded-xl border-y-2 border-x-0 sm:border-2 border-base-300 mb-6">
              <h3 class="text-sm font-bold uppercase tracking-wide text-base-content/60 mb-3">Tech Stack</h3>
              <div class="flex flex-wrap gap-3">
                {stack.map((tech) => (
                  <span class={`badge ${getStackColor(tech)} font-medium`}>
                    {tech}
                  </span>
                ))}
              </div>
            </section>
          )}

          <!-- Project Tags -->
          {tags && tags.length > 0 && (
            <section class="solid-bg p-4 sm:p-5 rounded-none sm:rounded-xl border-y-2 border-x-0 sm:border-2 border-base-300 mb-6">
              <h3 class="text-sm font-bold uppercase tracking-wide text-base-content/60 mb-3">Tags</h3>
              <div class="flex flex-wrap gap-3">
                {tags.map((tag) => (
                  <span class="badge badge-outline">
                    {tag}
                  </span>
                ))}
              </div>
            </section>
          )}
          
          <!-- Quick Info -->
          <section class="solid-bg-muted p-4 sm:p-5 rounded-none sm:rounded-xl border-y-2 border-x-0 sm:border-2 border-base-300 mb-6">
            <h3 class="text-sm font-bold uppercase tracking-wide text-base-content/60 mb-3">Project Info</h3>
            <dl class="space-y-3 text-sm">
              {company && (
                <div>
                  <dt class="text-base-content/50 font-medium">Company</dt>
                  <dd class="text-base-content font-semibold">{company}</dd>
                </div>
              )}
              {roleCategory && (
                <div>
                  <dt class="text-base-content/50 font-medium">Role</dt>
                  <dd class="text-base-content font-semibold">{roleCategory}</dd>
                </div>
              )}
              <div>
                <dt class="text-base-content/50 font-medium">Timeline</dt>
                <dd class="text-base-content font-semibold">{dateRange}</dd>
              </div>
            </dl>
          </section>
          
          <!-- Article Outline (desktop only) -->
          <section class="hidden lg:block solid-bg p-4 sm:p-5 rounded-xl border-2 border-base-300">
            <ArticleOutline />
          </section>
        </div>
      </aside>
    </div>
  </article>
)}

<script>
  // Preload full-size images on hover for faster detail page loads
  const preloadedImages = new Set<string>();
  
  function setupHoverPreload() {
    document.querySelectorAll('[data-preload-image]').forEach((card) => {
      card.addEventListener('mouseenter', () => {
        const imageUrl = card.getAttribute('data-preload-image');
        if (imageUrl && !preloadedImages.has(imageUrl)) {
          preloadedImages.add(imageUrl);
          const link = document.createElement('link');
          link.rel = 'preload';
          link.as = 'image';
          link.href = imageUrl;
          link.type = 'image/webp';
          document.head.appendChild(link);
        }
      }, { once: true });
    });
  }
  
  // Run on initial load and after view transitions
  setupHoverPreload();
  document.addEventListener('astro:page-load', setupHoverPreload);
</script>