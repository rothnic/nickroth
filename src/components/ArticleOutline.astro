---
/**
 * ArticleOutline Component
 * 
 * Displays a table of contents generated from the page's H2 headings.
 * Can be used in both desktop sticky sidebar and mobile bottom-sheet contexts.
 * 
 * This is a "view-only" component - the actual heading detection and
 * navigation logic is handled by client-side JavaScript in the parent container.
 * 
 * Usage:
 * <ArticleOutline />
 * 
 * The component renders an empty container that gets populated client-side
 * by scanning for .prose-content h2 elements.
 */

interface Props {
  /** Optional class name for custom styling */
  class?: string;
  showHeading?: boolean;
}

const { class: className = '', showHeading = true } = Astro.props;
---

<nav 
  class:list={["article-outline", className]}
  aria-label="Article outline"
>
  {showHeading && (
    <h3 class="text-sm font-bold uppercase tracking-wide text-base-content/60 mb-3">
      Contents
    </h3>
  )}
  <ul class="article-outline-list space-y-1" role="list">
    <!-- Populated by client-side JavaScript -->
    <li class="article-outline-placeholder text-sm text-base-content/40 italic">
      <span>Loading outline...</span>
    </li>
  </ul>
</nav>

<style is:global>
  .article-outline-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .article-outline-list li {
    padding: 0;
    margin: 0;
  }
  
  /* Base link styles - smaller for sidebar context */
  .article-outline-list a {
    display: block;
    padding: 0.375rem 0.5rem;
    font-size: 0.75rem;
    font-weight: 400;
    color: oklch(0.45 0 0);
    text-decoration: none;
    border-left: 2px solid transparent;
    transition: color 0.15s ease, border-color 0.15s ease, background-color 0.15s ease;
    line-height: 1.3;
  }
  
  /* H2 items - bold top-level headings */
  .article-outline-list li[data-level="2"] a {
    font-weight: 600;
    font-size: 0.8125rem;
    padding-top: 0.5rem;
    padding-bottom: 0.375rem;
  }
  
  /* First H2 shouldn't have extra top padding */
  .article-outline-list li[data-level="2"]:first-child a {
    padding-top: 0.375rem;
  }
  
  /* H3 nested items - indented and lighter */
  .article-outline-list li[data-level="3"] a {
    padding-left: 1rem;
    font-size: 0.6875rem;
    font-weight: 400;
    color: oklch(0.5 0 0);
  }
  
  .article-outline-list a:hover {
    color: var(--color-primary);
    background-color: oklch(0.97 0.01 280);
  }
  
  .article-outline-list a.active {
    color: var(--color-primary);
    border-left-color: var(--color-primary);
    font-weight: 600;
    background-color: oklch(0.95 0.02 280);
  }
  
  /* Dark mode */
  [data-theme="neobrutalism-dark"] .article-outline-list a {
    color: oklch(0.65 0 0);
  }
  
  [data-theme="neobrutalism-dark"] .article-outline-list li[data-level="3"] a {
    color: oklch(0.55 0 0);
  }
  
  [data-theme="neobrutalism-dark"] .article-outline-list a:hover {
    color: var(--color-primary);
    background-color: oklch(0.22 0.01 280);
  }
  
  [data-theme="neobrutalism-dark"] .article-outline-list a.active {
    color: var(--color-primary);
    background-color: oklch(0.2 0.02 280);
  }
</style>

<script>
  /**
   * Initialize the article outline by scanning for headings
   */
  function initArticleOutline() {
    const outlines = document.querySelectorAll('.article-outline:not(.initialized)');
    
    outlines.forEach((outline) => {
      outline.classList.add('initialized');
      
      const list = outline.querySelector('.article-outline-list');
      if (!list) return;
      
      // Find all headings in prose content
      const proseContent = document.querySelector('.prose-content');
      if (!proseContent) {
        // No prose content found - show empty state
        list.innerHTML = '<li class="text-sm text-base-content/40 italic px-3 py-2">No sections found</li>';
        return;
      }
      
      const headings = proseContent.querySelectorAll('h2, h3');
      
      if (headings.length === 0) {
        list.innerHTML = '<li class="text-sm text-base-content/40 italic px-3 py-2">No sections found</li>';
        return;
      }
      
      // Generate outline items
      const items: string[] = [];
      let h2Count = 0;
      
      headings.forEach((heading, index) => {
        const level = heading.tagName.toLowerCase() === 'h2' ? 2 : 3;
        
        // Skip the first H2 if it's "Impact Statement" (usually duplicates header info)
        if (level === 2) {
          h2Count++;
          if (h2Count === 1 && heading.textContent?.trim().toLowerCase() === 'impact statement') {
            return;
          }
        }
        
        // Ensure heading has an ID for navigation
        let id = heading.id;
        if (!id) {
          id = `heading-${index}`;
          heading.id = id;
        }
        
        const text = heading.textContent?.trim() || 'Untitled';
        items.push(`
          <li data-level="${level}">
            <a href="#${id}" data-outline-link="${id}" data-astro-history="replace">${text}</a>
          </li>
        `);
      });
      
      if (items.length === 0) {
        list.innerHTML = '<li class="text-sm text-base-content/40 italic px-3 py-2">No sections found</li>';
        return;
      }
      
      list.innerHTML = items.join('');
      
      // Set up intersection observer for active state
      setupActiveStateTracking(outline, headings);
      
      // Set up click handlers for smooth scrolling and bottom-sheet closing
      setupClickHandlers(outline);
    });
  }
  
  /**
   * Track which heading is currently in view and update active state
   */
  function setupActiveStateTracking(outline: Element, headings: NodeListOf<Element>) {
    const links = outline.querySelectorAll('[data-outline-link]');
    
    // Create intersection observer for headings
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const id = entry.target.id;
            
            // Update active state
            links.forEach((link) => {
              const linkId = link.getAttribute('data-outline-link');
              if (linkId === id) {
                link.classList.add('active');
              } else {
                link.classList.remove('active');
              }
            });
          }
        });
      },
      {
        rootMargin: '-20% 0% -60% 0%', // Trigger when heading is in top portion of viewport
        threshold: 0
      }
    );
    
    headings.forEach((heading) => {
      if (heading.id) {
        observer.observe(heading);
      }
    });
    
    // Store observer reference for cleanup
    (outline as any)._outlineObserver = observer;
  }
  
  /**
   * Set up click handlers for outline links (desktop sidebar only)
   * Mobile bottom sheet handles its own clicks in OutlineBottomSheet.astro
   * 
   * NOTE: We don't prevent default or manually scroll anymore. Astro's router
   * handles hash navigation correctly. The data-astro-history="replace" attribute
   * ensures outline clicks don't create history entries.
   */
  function setupClickHandlers(outline: Element) {
    // Skip if this is inside a bottom sheet (mobile)
    if (outline.closest('.outline-bottom-sheet')) {
      return;
    }
    
    // No custom handlers needed - let Astro's router handle hash navigation
    // The links already have data-astro-history="replace" to prevent history entries
  }
  
  // Initialize on load and after view transitions
  initArticleOutline();
  document.addEventListener('astro:page-load', initArticleOutline);
  document.addEventListener('astro:after-swap', () => {
    // Clean up any observers from old page
    document.querySelectorAll('.article-outline.initialized').forEach((outline) => {
      const observer = (outline as any)._outlineObserver;
      if (observer) {
        observer.disconnect();
      }
    });
  });
  
  // Listen for custom event when outline container is dynamically added (e.g., mobile bottom sheet)
  document.addEventListener('outline-container-added', (e) => {
    // Initialize the specific outline that was just added
    const target = e.target as Element;
    if (target && target.classList.contains('article-outline')) {
      // Re-run initialization for this specific outline
      initArticleOutline();
    }
  });
</script>
