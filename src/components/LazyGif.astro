---
/**
 * LazyGif Component
 * 
 * Displays a placeholder with play button, then lazy-loads the GIF/video
 * when clicked. Automatically extracts first frame as poster if not provided.
 * 
 * Usage in MDX:
 * <LazyGif 
 *   src="/demos/filter-transitions.gif" 
 *   alt="Filter navigation animation"
 *   caption="View transitions keep 'PROJECTS' stable while the category morphs"
 * />
 * 
 * Or with explicit poster:
 * <LazyGif 
 *   src="/demos/filter-transitions.gif" 
 *   poster="/demos/filter-transitions-poster.webp"
 *   alt="Filter navigation animation"
 * />
 */

interface Props {
  /** Path to GIF or WebM video */
  src: string;
  /** Alt text for accessibility */
  alt: string;
  /** Optional poster image - if not provided, uses canvas extraction for GIF or video poster */
  poster?: string;
  /** Optional caption below the animation */
  caption?: string;
  /** Optional width */
  width?: number;
  /** Optional height */  
  height?: number;
}

const { src, poster, alt, caption, width, height } = Astro.props;

// Determine if source is a video (webm/mp4) or GIF
const isVideo = src.endsWith('.webm') || src.endsWith('.mp4');
---

<figure class="lazy-gif-container">
  <div 
    class="lazy-gif-wrapper" 
    data-src={src}
    data-is-video={isVideo.toString()}
    data-poster={poster || ''}
  >
    {/* Poster image - shown initially if provided */}
    {poster && (
      <img 
        src={poster} 
        alt={alt}
        width={width}
        height={height}
        loading="lazy"
        class="lazy-gif-poster"
      />
    )}
    
    {/* Canvas for extracting first frame when no poster provided */}
    {!poster && (
      <canvas class="lazy-gif-poster lazy-gif-canvas" aria-hidden="true"></canvas>
    )}
    
    {/* Play button overlay */}
    <button class="lazy-gif-play" aria-label="Play animation">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M8 5v14l11-7z"/>
      </svg>
    </button>
    
    {/* Animation container (hidden until loaded) */}
    {isVideo ? (
      <video 
        data-src={src}
        class="lazy-gif-animation"
        muted
        loop
        playsinline
        style="display: none;"
      ></video>
    ) : (
      <img 
        data-src={src}
        alt={alt}
        width={width}
        height={height}
        class="lazy-gif-animation"
        style="display: none;"
      />
    )}
    
    {/* Loading indicator */}
    <div class="lazy-gif-loading" style="display: none;">
      <span>Loading...</span>
    </div>
  </div>
  
  {caption && <figcaption class="lazy-gif-caption">{caption}</figcaption>}
</figure>

<style>
  .lazy-gif-container {
    margin: 2rem 0;
  }
  
  .lazy-gif-wrapper {
    position: relative;
    display: block;
    width: 100%;
    border: 3px solid oklch(0.2 0 0);
    overflow: hidden;
    cursor: pointer;
    background: oklch(0.95 0 0);
    min-height: 200px;
  }
  
  .lazy-gif-poster,
  .lazy-gif-animation {
    display: block;
    width: 100%;
    height: auto;
  }
  
  .lazy-gif-canvas {
    width: 100%;
    min-height: 200px;
    background: linear-gradient(135deg, oklch(0.95 0 0) 0%, oklch(0.9 0.02 280) 100%);
  }
  
  .lazy-gif-play {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80px;
    height: 80px;
    background: var(--color-primary);
    border: 3px solid oklch(0.2 0 0);
    border-radius: 0;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 4px 4px 0 0 oklch(0.2 0 0);
    transition: transform 0.1s, box-shadow 0.1s;
  }
  
  .lazy-gif-play:hover {
    transform: translate(calc(-50% - 2px), calc(-50% - 2px));
    box-shadow: 6px 6px 0 0 oklch(0.2 0 0);
  }
  
  .lazy-gif-play:active {
    transform: translate(-50%, -50%);
    box-shadow: 2px 2px 0 0 oklch(0.2 0 0);
  }
  
  .lazy-gif-play svg {
    width: 40px;
    height: 40px;
  }
  
  .lazy-gif-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--color-primary);
    color: white;
    padding: 1rem 2rem;
    font-weight: 700;
    text-transform: uppercase;
    border: 3px solid oklch(0.2 0 0);
  }
  
  .lazy-gif-caption {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: oklch(0.5 0 0);
    font-style: italic;
    text-align: center;
  }
  
  /* Playing state */
  .lazy-gif-wrapper.playing .lazy-gif-poster,
  .lazy-gif-wrapper.playing .lazy-gif-play {
    display: none !important;
  }
  
  .lazy-gif-wrapper.playing .lazy-gif-animation {
    display: block !important;
  }
  
  /* Loading state */
  .lazy-gif-wrapper.loading .lazy-gif-play {
    display: none;
  }
  
  .lazy-gif-wrapper.loading .lazy-gif-loading {
    display: block !important;
  }
  
  /* Dark mode */
  [data-theme="neobrutalism-dark"] .lazy-gif-wrapper {
    background: oklch(0.2 0 0);
  }
  
  [data-theme="neobrutalism-dark"] .lazy-gif-canvas {
    background: linear-gradient(135deg, oklch(0.2 0 0) 0%, oklch(0.25 0.02 280) 100%);
  }
</style>

<script>
  // Initialize all lazy GIF/video components
  function initLazyGifs() {
    document.querySelectorAll('.lazy-gif-wrapper').forEach((wrapper) => {
      const el = wrapper as HTMLElement;
      const playButton = el.querySelector('.lazy-gif-play') as HTMLButtonElement;
      const animation = el.querySelector('.lazy-gif-animation') as HTMLImageElement | HTMLVideoElement;
      const canvas = el.querySelector('.lazy-gif-canvas') as HTMLCanvasElement | null;
      const src = el.dataset.src;
      const isVideo = el.dataset.isVideo === 'true';
      const hasPoster = el.dataset.poster !== '';
      
      if (!playButton || !animation || !src) return;
      
      // Already initialized
      if (el.classList.contains('initialized')) return;
      el.classList.add('initialized');
      
      // For videos without poster, extract first frame
      if (isVideo && !hasPoster && canvas) {
        const video = document.createElement('video');
        video.crossOrigin = 'anonymous';
        video.muted = true;
        video.preload = 'metadata';
        
        video.onloadeddata = () => {
          video.currentTime = 0.1; // Slight offset to ensure frame is loaded
        };
        
        video.onseeked = () => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          const ctx = canvas.getContext('2d');
          if (ctx) {
            ctx.drawImage(video, 0, 0);
          }
        };
        
        video.src = src;
      }
      
      // Handle play button click
      playButton.addEventListener('click', () => {
        el.classList.add('loading');
        
        if (isVideo) {
          const videoEl = animation as HTMLVideoElement;
          videoEl.oncanplay = () => {
            el.classList.remove('loading');
            el.classList.add('playing');
            videoEl.play();
          };
          videoEl.onerror = () => {
            el.classList.remove('loading');
            console.error('Failed to load video:', src);
          };
          videoEl.src = src;
        } else {
          const imgEl = animation as HTMLImageElement;
          imgEl.onload = () => {
            el.classList.remove('loading');
            el.classList.add('playing');
          };
          imgEl.onerror = () => {
            el.classList.remove('loading');
            console.error('Failed to load GIF:', src);
          };
          imgEl.src = src;
        }
      });
      
      // Click animation to pause/stop
      animation.addEventListener('click', () => {
        if (isVideo) {
          const videoEl = animation as HTMLVideoElement;
          videoEl.pause();
          videoEl.currentTime = 0;
        }
        el.classList.remove('playing');
      });
    });
  }
  
  // Initialize on page load and after view transitions
  initLazyGifs();
  document.addEventListener('astro:after-swap', initLazyGifs);
</script>
