---
/**
 * LazyGif Component
 * 
 * Shows a still poster image initially. When the element enters the viewport,
 * it preloads and auto-plays the animation. By the time the user scrolls to it,
 * the content is typically already loaded and playing seamlessly.
 * 
 * Usage in MDX:
 * <LazyGif 
 *   src="/demos/filter-transitions.webm" 
 *   alt="Filter navigation animation"
 *   caption="View transitions keep 'PROJECTS' stable"
 * />
 * 
 * Or with explicit poster:
 * <LazyGif 
 *   src="/demos/filter-transitions.webm" 
 *   poster="/demos/filter-transitions-poster.webp"
 *   alt="Filter navigation animation"
 * />
 */

interface Props {
  /** Path to GIF or WebM video */
  src: string;
  /** Alt text for accessibility */
  alt: string;
  /** Optional poster image - if not provided for video, extracts first frame */
  poster?: string;
  /** Optional caption below the animation */
  caption?: string;
  /** Optional width */
  width?: number;
  /** Optional height */  
  height?: number;
}

const { src, poster, alt, caption, width, height } = Astro.props;

// Determine if source is a video (webm/mp4) or GIF
const isVideo = src.endsWith('.webm') || src.endsWith('.mp4');
---

<figure class="lazy-gif-container">
  <div 
    class="lazy-gif-wrapper" 
    data-src={src}
    data-is-video={isVideo.toString()}
    data-poster={poster || ''}
  >
    {/* Poster image - shown until animation loads */}
    {poster ? (
      <img 
        src={poster} 
        alt={alt}
        width={width}
        height={height}
        loading="lazy"
        class="lazy-gif-poster"
      />
    ) : (
      /* For video without poster, show first frame via video element */
      isVideo ? (
        <video 
          src={src}
          class="lazy-gif-poster"
          muted
          preload="metadata"
        ></video>
      ) : (
        /* For GIF without poster, show placeholder */
        <div class="lazy-gif-placeholder" aria-hidden="true">
          <span>Loading preview...</span>
        </div>
      )
    )}
    
    {/* Animation container (hidden until loaded) */}
    {isVideo ? (
      <video 
        data-src={src}
        class="lazy-gif-animation"
        muted
        loop
        playsinline
        style="display: none;"
      ></video>
    ) : (
      <img 
        data-src={src}
        alt={alt}
        width={width}
        height={height}
        class="lazy-gif-animation"
        style="display: none;"
      />
    )}
    
    {/* Loading indicator - shows during load */}
    <div class="lazy-gif-loading" style="display: none;">
      <span>Loading...</span>
    </div>
  </div>
  
  {caption && <figcaption class="lazy-gif-caption">{caption}</figcaption>}
</figure>

<style>
  .lazy-gif-container {
    margin: 2rem 0;
  }
  
  .lazy-gif-wrapper {
    position: relative;
    display: block;
    width: 100%;
    border: 3px solid oklch(0.2 0 0);
    overflow: hidden;
    background: oklch(0.95 0 0);
  }
  
  .lazy-gif-poster,
  .lazy-gif-animation {
    display: block;
    width: 100%;
    height: auto;
  }
  
  .lazy-gif-placeholder {
    width: 100%;
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, oklch(0.95 0 0) 0%, oklch(0.9 0.02 280) 100%);
    font-weight: 500;
    color: oklch(0.5 0 0);
  }
  
  .lazy-gif-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--color-primary);
    color: white;
    padding: 0.75rem 1.5rem;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.875rem;
    border: 3px solid oklch(0.2 0 0);
  }
  
  .lazy-gif-caption {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: oklch(0.5 0 0);
    font-style: italic;
    text-align: center;
  }
  
  /* Playing state - show animation, hide poster */
  .lazy-gif-wrapper.playing .lazy-gif-poster,
  .lazy-gif-wrapper.playing .lazy-gif-placeholder {
    display: none !important;
  }
  
  .lazy-gif-wrapper.playing .lazy-gif-animation {
    display: block !important;
  }
  
  /* Loading state */
  .lazy-gif-wrapper.loading .lazy-gif-loading {
    display: block !important;
  }
  
  /* Dark mode */
  [data-theme="neobrutalism-dark"] .lazy-gif-wrapper {
    background: oklch(0.2 0 0);
    border-color: oklch(0.4 0 0);
  }
  
  [data-theme="neobrutalism-dark"] .lazy-gif-placeholder {
    background: linear-gradient(135deg, oklch(0.2 0 0) 0%, oklch(0.25 0.02 280) 100%);
    color: oklch(0.6 0 0);
  }
  
  [data-theme="neobrutalism-dark"] .lazy-gif-caption {
    color: oklch(0.6 0 0);
  }
</style>

<script>
  // IntersectionObserver for auto-loading when visible
  function initLazyGifs() {
    const wrappers = document.querySelectorAll('.lazy-gif-wrapper:not(.initialized)');
    
    if (!wrappers.length) return;
    
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const wrapper = entry.target as HTMLElement;
          loadAndPlayAnimation(wrapper);
          observer.unobserve(wrapper);
        }
      });
    }, {
      rootMargin: '200px', // Start loading 200px before it enters viewport
      threshold: 0
    });
    
    wrappers.forEach((wrapper) => {
      wrapper.classList.add('initialized');
      observer.observe(wrapper);
    });
  }
  
  function loadAndPlayAnimation(wrapper: HTMLElement) {
    const animation = wrapper.querySelector('.lazy-gif-animation') as HTMLImageElement | HTMLVideoElement;
    const src = wrapper.dataset.src;
    const isVideo = wrapper.dataset.isVideo === 'true';
    
    if (!animation || !src) return;
    
    // Show loading indicator
    wrapper.classList.add('loading');
    
    if (isVideo) {
      const videoEl = animation as HTMLVideoElement;
      
      videoEl.oncanplay = () => {
        wrapper.classList.remove('loading');
        wrapper.classList.add('playing');
        videoEl.play().catch(() => {
          // Autoplay might be blocked - that's ok, video will show
        });
      };
      
      videoEl.onerror = () => {
        wrapper.classList.remove('loading');
        console.error('Failed to load video:', src);
      };
      
      videoEl.src = src;
      videoEl.load();
    } else {
      const imgEl = animation as HTMLImageElement;
      
      imgEl.onload = () => {
        wrapper.classList.remove('loading');
        wrapper.classList.add('playing');
      };
      
      imgEl.onerror = () => {
        wrapper.classList.remove('loading');
        console.error('Failed to load GIF:', src);
      };
      
      imgEl.src = src;
    }
  }
  
  // Initialize on page load and after view transitions
  initLazyGifs();
  document.addEventListener('astro:after-swap', initLazyGifs);
</script>
