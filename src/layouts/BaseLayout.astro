---
import { ClientRouter } from "astro:transitions";
import { Font, getImage } from "astro:assets";
import Navbar from "../components/Navbar.astro";
import "../styles/global.css";

// Preload hero image for homepage LCP optimization
import headshot from "../assets/images/nick-headshot.png";
const heroImage = await getImage({
  src: headshot,
  width: 384,
  format: "webp",
  quality: 75,
});

export interface Props {
	title?: string;
	description?: string;
	showNavbar?: boolean;
}

const {
	title = "Nick Roth - Product Manager & AI Engineer",
	description = "Personal site for Nick Roth",
	showNavbar = true,
} = Astro.props;

const currentPath = Astro.url.pathname;
const isHomepage = currentPath === "/" || currentPath === "";
---

<!doctype html>
<html lang="en" data-theme="neobrutalism-light">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    {/* Preload hero image for LCP on homepage */}
    {isHomepage && (
      <link 
        rel="preload" 
        as="image" 
        href={heroImage.src}
        type="image/webp"
        fetchpriority="high"
      />
    )}
    <!-- Fonts via Astro experimental fonts API with automatic subsetting -->
    <Font cssVariable="--font-display" preload />
    <Font cssVariable="--font-mono" />
    <Font cssVariable="--font-glitch" />
    <title>{title}</title>
    <ClientRouter />
    <script src="/src/scripts/theme.js"></script>
  </head>
  <script>
    import { initScrollAnimations } from "../scripts/animations.js";
    import { initViewTransitionScrolling } from "../scripts/view-transitions.js";
    import { initFilterBarTransitions } from "../scripts/filter-bar-transitions.js";

    // Disable automatic scroll restoration - let view-transitions.js handle all scrolling
    // This prevents the browser from scrolling to top (0,0) before our smart scroll logic runs
    if ('scrollRestoration' in history) {
      history.scrollRestoration = 'manual';
    }

    // Initialize on page load
    initScrollAnimations();
    initViewTransitionScrolling();
    initFilterBarTransitions(); // Global filter bar visibility handlers

    // Reinitialize on Astro page transitions
    document.addEventListener("astro:page-load", () => {
      initScrollAnimations();
    });

    // Enable smooth scrolling ONLY for anchor links (within-page navigation)
    // This avoids conflicts with view transitions during page-to-page navigation
    document.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;
      const link = target.closest("a");
      
      if (!link) return;
      
      const href = link.getAttribute("href");
      
      // Check if it's an anchor link (starts with #)
      if (href && href.startsWith("#")) {
        e.preventDefault();
        
        const targetId = href.substring(1);
        const targetElement = document.getElementById(targetId);
        
        if (targetElement) {
          // Check user's motion preference
          const prefersReducedMotion = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
          
          // Temporarily enable smooth scroll for this anchor navigation only
          if (!prefersReducedMotion) {
            document.documentElement.style.scrollBehavior = "smooth";
          }
          
          targetElement.scrollIntoView({ behavior: prefersReducedMotion ? "auto" : "smooth" });
          
          // Update URL hash
          history.pushState(null, "", href);
          
          // Reset scroll behavior after scrolling completes
          setTimeout(() => {
            document.documentElement.style.scrollBehavior = "auto";
          }, 1000);
        }
      }
    });
  </script>
  <style>
    @keyframes scale-up {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    @keyframes scale-down {
      from { transform: scale(1); opacity: 1; }
      to { transform: scale(0.8); opacity: 0; }
    }
  </style>
  <body>
    <div class="min-h-screen flex flex-col">
      {showNavbar && <Navbar currentPath={currentPath} />}
      <slot />
      <footer class="footer footer-center p-6 text-base-content/60 mt-auto">
        <p class="text-sm">Â© 2024 Nick Roth. All rights reserved.</p>
      </footer>
    </div>
  </body>
</html>