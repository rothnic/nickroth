---
import BaseLayout from '../../layouts/BaseLayout.astro';
import WorkCard from '../../components/WorkCard.astro';
import { getCollection } from 'astro:content';

const workEntries = await getCollection('work');
const sortedWork = workEntries
  .sort((a, b) => {
    const aDate = a.data.endDate || new Date();
    const bDate = b.data.endDate || new Date();  
    return bDate.getTime() - aDate.getTime();
  });

// Get unique categories for filtering
const categories = ['ALL WORK', ...new Set(workEntries.map(work => work.data.category).filter(Boolean))];
---

<BaseLayout title="Work Portfolio - Nick Roth" description="Case studies demonstrating systematic approach to product development from discovery through delivery">
  <main class="pt-16 pb-28">
    <div class="container mx-auto max-w-6xl px-5 sm:px-6">
      <header class="mb-12 flex flex-col gap-6 text-center sm:mb-16">
        <div class="mx-auto inline-flex items-center gap-3 rounded-full border border-base-300/70 bg-base-100/80 px-6 py-2 text-xs font-semibold uppercase tracking-[0.32em] text-base-content/65 shadow-brutal-pop">
          <span class="inline-flex h-2.5 w-2.5 rounded-full bg-primary"></span>
          Case Study Archive
        </div>
        <div class="space-y-6">
          <h1 class="text-4xl font-black tracking-tight text-base-content sm:text-5xl">
            Automations, platforms, and playbooks with measurable lift.
          </h1>
          <p class="mx-auto max-w-3xl text-sm leading-relaxed text-base-content/75 sm:text-base">
            Click any card to expand the highlights, stack, and impact before diving into the full build. Filters animate with view transitions, so hopping between focuses keeps the page feeling alive.
          </p>
        </div>
      </header>

      <section class="mb-12 flex flex-wrap items-center justify-center gap-3" aria-label="Filter work by category">
        {categories.map((category, index) => (
          <button
            class={`filter-chip ${index === 0 ? 'is-active' : ''}`}
            data-filter-button
            data-category={category}
            type="button"
          >
            <span class="filter-chip__label">{category}</span>
          </button>
        ))}
      </section>

      <div class="grid grid-cols-1 gap-8 lg:grid-cols-2" data-work-grid>
        {sortedWork.map((work) => (
          <WorkCard
            title={work.data.title}
            description={work.data.description}
            company={work.data.company}
            role={work.data.role}
            slug={work.slug}
            tags={work.data.tags}
            image={work.data.image}
            category={work.data.category}
            impact={work.data.impact}
            stack={work.data.stack}
            roleCategory={work.data.roleCategory}
            variant="interactive"
          />
        ))}
      </div>

      {sortedWork.length === 0 && (
        <div class="mt-24 text-center text-base-content/70">
          <p class="text-lg">No work entries yet. Check back soon!</p>
        </div>
      )}
    </div>
  </main>

  <script>
    const setupFilters = () => {
      const categoryButtons = Array.from(document.querySelectorAll('[data-filter-button]')) as HTMLButtonElement[];
      const workCards = Array.from(document.querySelectorAll('[data-work-card]')) as HTMLElement[];

      if (!categoryButtons.length || !workCards.length) return;

      const activateButton = (active: HTMLButtonElement) => {
        categoryButtons.forEach((button) => {
          button.classList.toggle('is-active', button === active);
        });
      };

      const filterCards = (category: string | null) => {
        const applyFilter = () => {
          workCards.forEach((card) => {
            const matches = !category || category === 'ALL WORK' || card.getAttribute('data-category') === category;
            card.toggleAttribute('hidden', !matches);
            if (!matches && 'open' in card && typeof card.open === 'boolean') {
              (card as HTMLDetailsElement).open = false;
            }
          });
        };

        if (document.startViewTransition) {
          document.startViewTransition(() => {
            applyFilter();
          });
        } else {
          applyFilter();
        }
      };

      categoryButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const category = button.getAttribute('data-category');
          activateButton(button);
          filterCards(category);
        });
      });
    };

    const bootstrap = () => {
      const grid = document.querySelector('[data-work-grid]') as HTMLElement | null;
      if (!grid || grid.dataset.filterBound === 'true') return;

      grid.dataset.filterBound = 'true';
      setupFilters();

      grid.addEventListener('toggle', (event) => {
        const target = event.target as HTMLDetailsElement;
        if (!target?.matches('[data-work-card]')) return;

        if (target.open && document.startViewTransition) {
          document.startViewTransition(() => {});
        }
      });
    };

    document.addEventListener('astro:page-load', bootstrap);
    document.addEventListener('DOMContentLoaded', bootstrap);
  </script>

  <style>
    [data-work-grid] {
      container-type: inline-size;
      container-name: work-grid;
    }

    .filter-chip {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      border-radius: 9999px;
      border: 1.5px solid rgba(23, 19, 33, 0.16);
      background: rgba(246, 244, 255, 0.65);
      padding: 0.55rem 1.35rem;
      text-transform: uppercase;
      letter-spacing: 0.28em;
      font-size: 0.65rem;
      font-weight: 700;
      color: hsl(var(--nc) / 0.7);
      transition: transform 200ms ease, box-shadow 220ms ease, color 200ms ease, border-color 200ms ease;
      backdrop-filter: blur(6px);
      isolation: isolate;
    }

    .filter-chip::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(120deg, rgba(255, 92, 138, 0.22), rgba(53, 245, 255, 0.18));
      opacity: 0;
      transition: opacity 220ms ease;
      z-index: -1;
    }

    .filter-chip:hover,
    .filter-chip:focus-visible {
      color: hsl(var(--p));
      border-color: rgba(255, 92, 138, 0.45);
      transform: translateY(-2px);
    }

    .filter-chip:hover::before,
    .filter-chip:focus-visible::before {
      opacity: 1;
    }

    .filter-chip.is-active {
      color: hsl(var(--p));
      border-color: rgba(255, 92, 138, 0.55);
      box-shadow: 0 10px 24px rgba(17, 24, 39, 0.12);
    }

    .filter-chip.is-active::before {
      opacity: 1;
    }

    .filter-chip__label {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }

    details[data-work-card][hidden] {
      display: none;
    }

    @container work-grid (max-width: 720px) {
      details[data-work-card] summary .flex {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</BaseLayout>
