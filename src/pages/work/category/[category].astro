---
import { type CollectionEntry, getCollection } from "astro:content";
import WorkCard from "../../../components/WorkCard.astro";
import BaseLayout from "../../../layouts/BaseLayout.astro";
import ContentLayout from "../../../components/ContentLayout.astro";
import PageHeader from "../../../components/PageHeader.astro";
import WorkCategoryFilter from "../../../components/WorkCategoryFilter.astro";

// Generate static paths for each category
export async function getStaticPaths() {
	const workEntries = await getCollection("work");
	const categories = [...new Set(workEntries.map((work) => work.data.category).filter(Boolean))] as string[];
	
	// Local slugify for getStaticPaths scope
	const toSlug = (text: string): string => {
		return text
			.toLowerCase()
			.replace(/[^a-z0-9]+/g, '-')
			.replace(/(^-|-$)/g, '');
	};
	
	return categories.map((category) => ({
		params: { category: toSlug(category) },
		props: { 
			category,
			entries: workEntries.filter((work) => work.data.category === category)
		},
	}));
}

type Props = {
	category: string;
	entries: CollectionEntry<"work">[];
};

const { category, entries } = Astro.props;

// Sort entries by date
const sortedWork = entries.sort((a, b) => {
	const aDate = a.data.endDate || new Date();
	const bDate = b.data.endDate || new Date();
	return bDate.getTime() - aDate.getTime();
});

// Get all unique categories - SORTED ALPHABETICALLY for consistency across all pages
const workEntries = await getCollection("work");
const allCategories = [...new Set(workEntries.map((work) => work.data.category).filter(Boolean))].sort() as string[];
---

<BaseLayout 
	title={`${category} Projects - Nick Roth`} 
	description={`Case studies in ${category.toLowerCase()}: systematic approach to product development`}
>
  <ContentLayout>
    <PageHeader
      title={category}
      subtitle="Projects"
      description={`Case studies in ${category.toLowerCase()} demonstrating systematic approach to product development.`}
    />

    <WorkCategoryFilter categories={allCategories} activeCategory={category} />

    <!-- Projects Grid -->
    <div class="grid grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-6 max-w-5xl mx-auto">
      {sortedWork.map((work) => (
        <WorkCard entry={work} mode="card" />
      ))}
    </div>
    
    {sortedWork.length === 0 && (
      <div class="text-center">
        <p class="text-lg opacity-75">No projects in this category yet.</p>
        <a href="/work" class="btn btn-primary mt-4">View All Projects</a>
      </div>
    )}
  </ContentLayout>
</BaseLayout>
