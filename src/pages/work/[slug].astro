---
import { type CollectionEntry, getCollection } from "astro:content";
import WorkCard from "../../components/WorkCard.astro";
import OutlineBottomSheet from "../../components/OutlineBottomSheet.astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import SchemaOrg from "../../components/SchemaOrg.astro";

export async function getStaticPaths() {
	const workEntries = await getCollection("work");
	return workEntries.map((entry: CollectionEntry<"work">) => ({
		params: { slug: entry.slug },
		props: { entry },
	}));
}

type Props = {
	entry: CollectionEntry<"work">;
};

const { entry } = Astro.props as Props;

// Helper to create URL-friendly slug
function slugify(text: string): string {
  return text
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/(^-|-$)/g, '');
}

const category = entry.data.category;
const categorySlug = category ? slugify(category) : null;

// Generate OG image URL for schema
const siteUrl = 'https://www.nickroth.com';
const canonicalUrl = `${siteUrl}/work/${entry.slug}`;
let ogImageUrl = '';
if (entry.data.image?.src) {
  ogImageUrl = `${siteUrl}${entry.data.image.src}`;
}

// Build breadcrumb data
const breadcrumbs = [
  { name: 'Home', url: siteUrl },
  { name: 'Work', url: `${siteUrl}/work` },
];
if (category && categorySlug) {
  breadcrumbs.push({ name: category, url: `${siteUrl}/work/category/${categorySlug}` });
}
breadcrumbs.push({ name: entry.data.title, url: canonicalUrl });
---

<BaseLayout title={`${entry.data.title} | Work - NR`} description={entry.data.description}>
  <!-- Schema.org structured data -->
  <SchemaOrg 
    type="Article"
    title={entry.data.title}
    description={entry.data.description}
    image={ogImageUrl}
    datePublished={entry.data.startDate}
    author={{ name: 'Nick Roth', url: siteUrl }}
  />
  <SchemaOrg 
    type="BreadcrumbList"
    breadcrumbs={breadcrumbs}
  />
  
  <main class="py-4">
    <!-- Card reference for scroll restoration when returning to work list -->
    <div data-card-ref={entry.slug} class="hidden"></div>
    <div class="container mx-auto px-0 sm:px-4 max-w-6xl">
      <!-- Breadcrumb Navigation - flat text styling like filter tags -->
      <nav class="mb-6 px-4 sm:px-0 flex items-center gap-1.5 text-sm font-black uppercase tracking-wide" transition:name="work-back-nav" aria-label="Breadcrumb">
        <a 
          href="/work" 
          class="text-base-content/70 hover:text-primary transition-colors"
        >
          Work
        </a>
        {category && categorySlug && (
          <>
            <span class="text-base-content/40">/</span>
            <a 
              href={`/work/category/${categorySlug}`}
              class="text-base-content/70 hover:text-primary transition-colors"
            >
              {category}
            </a>
          </>
        )}
      </nav>

      <!-- Use WorkCard component in expanded mode -->
      <WorkCard entry={entry} mode="expanded" />

      <!-- Navigation Footer -->
      <div class="pt-6 border-t border-base-300 mt-8 px-4 sm:px-0" transition:name="work-footer-nav">
        <div class="flex flex-wrap justify-between items-center gap-2">
          <a href="/work" class="btn btn-sm sm:btn-md btn-primary">
            ← View All Projects
          </a>
          <a href="/contact" class="btn btn-sm sm:btn-md btn-outline">
            Discuss Your Project →
          </a>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Mobile outline bottom sheet -->
  <OutlineBottomSheet />
</BaseLayout>