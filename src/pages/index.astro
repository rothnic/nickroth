---
import { getCollection } from 'astro:content';

import BaseLayout from '../layouts/BaseLayout.astro';
import { CapabilitiesTabs } from '../components/site/CapabilitiesTabs';
import { HomeHero } from '../components/site/HomeHero';
import { NotesGrid } from '../components/site/NotesGrid';
import { WorkShowcase } from '../components/site/WorkShowcase';

const capabilitiesEntries = await getCollection('capabilities');
const capabilities = capabilitiesEntries
  .sort((a, b) => a.data.order - b.data.order)
  .map((item, index) => ({
    slug: item.slug ?? `capability-${index}`,
    title: item.data.title,
    description: item.data.description,
    icon: item.data.icon,
  }));

const workEntries = await getCollection('work');
const featuredWork = workEntries
  .filter((item) => item.data.featured)
  .sort((a, b) => {
    const aDate = itemDate(a.data.endDate ?? a.data.startDate);
    const bDate = itemDate(b.data.endDate ?? b.data.startDate);
    return bDate.getTime() - aDate.getTime();
  })
  .slice(0, 4)
  .map((item) => ({
    slug: item.slug,
    title: item.data.title,
    description: item.data.description,
    company: item.data.company,
    role: item.data.role,
    tags: item.data.tags,
    category: item.data.category,
    impact: item.data.impact,
  }));

const noteEntries = await getCollection('notes');
const recentNotes = noteEntries
  .filter((note) => !note.data.draft)
  .sort((a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime())
  .slice(0, 6)
  .map((note) => ({
    slug: note.slug,
    title: note.data.title,
    description: note.data.description,
    publishDate: note.data.publishDate.toISOString(),
    tags: note.data.tags,
  }));

function itemDate(date: Date) {
  return new Date(date);
}
---
<BaseLayout>
  <HomeHero client:load />
  <div class="py-20">
    <CapabilitiesTabs client:load items={capabilities} />
  </div>
  <div class="py-20">
    <WorkShowcase client:load items={featuredWork} />
  </div>
  <div class="py-20">
    <NotesGrid client:load items={recentNotes} />
  </div>
</BaseLayout>
