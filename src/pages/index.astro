---
import BaseLayout from '../layouts/BaseLayout.astro';
import Hero from '../components/Hero.astro';
import CapabilityCard from '../components/CapabilityCard.astro';
import WorkCard from '../components/WorkCard.astro';
import { getCollection } from 'astro:content';

const capabilities = await getCollection('capabilities');
const sortedCapabilities = capabilities.sort((a, b) => a.data.order - b.data.order);

const work = await getCollection('work');
const featuredWork = work
  .filter((w) => w.data.featured)
  .sort((a, b) => {
    const aDate = a.data.endDate || new Date();
    const bDate = b.data.endDate || new Date();
    return bDate.getTime() - aDate.getTime();
  })
  .slice(0, 2);

const notes = await getCollection('notes');
const recentNotes = notes
  .sort((a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime())
  .slice(0, 3);
---

<BaseLayout>
  <Hero />

  <section class="py-24">
    <div class="max-w-6xl mx-auto px-6 space-y-14">
      <div class="flex flex-col gap-6 md:flex-row md:items-end md:justify-between">
        <div class="space-y-4">
          <p class="text-xs uppercase tracking-[0.4em] text-base-content/60">Services</p>
          <h2 class="text-3xl sm:text-4xl font-semibold tracking-tight">Core capabilities</h2>
          <p class="max-w-2xl text-sm text-base-content/80 leading-relaxed">
            Product, engineering, and operations move faster when they share the same playbook.
            These are the programs I stand up and tune for clients who need measurable leverage.
          </p>
        </div>
        <a href="/approach" class="btn btn-outline border-2 border-base-300/80 hover:border-primary/60">
          View the delivery approach
        </a>
      </div>

      <div class="grid gap-8 sm:grid-cols-2 lg:grid-cols-3">
        {sortedCapabilities.map((capability) => (
          <CapabilityCard
            title={capability.data.title}
            description={capability.data.description}
            icon={capability.data.icon}
          />
        ))}
      </div>
    </div>
  </section>

  <section class="bg-base-200/60 py-24">
    <div class="max-w-6xl mx-auto px-6 space-y-14">
      <div class="flex flex-col gap-6 md:flex-row md:items-end md:justify-between">
        <div class="space-y-4 max-w-3xl">
          <p class="text-xs uppercase tracking-[0.4em] text-base-content/60">Case Studies</p>
          <h2 class="text-3xl sm:text-4xl font-semibold tracking-tight">Recent work</h2>
          <p class="text-sm text-base-content/80 leading-relaxed">
            High-signal snapshots of AI-enabled systems, content platforms, and marketing automation work.
            Each card covers the objectives, systems work, and deltas in performance.
          </p>
        </div>
        <a href="/work" class="btn btn-primary">View portfolio</a>
      </div>

      {featuredWork.length > 0 && (
        <div class="grid gap-8 lg:grid-cols-2">
          {featuredWork.map((project) => (
            <WorkCard
              title={project.data.title}
              description={project.data.description}
              company={project.data.company}
              role={project.data.role}
              slug={project.slug}
              tags={project.data.tags}
              image={project.data.image}
              category={project.data.category}
              impact={project.data.impact}
              stack={project.data.stack}
              roleCategory={project.data.roleCategory}
            />
          ))}
        </div>
      )}

      <div class="flex flex-wrap items-center justify-between gap-4 rounded-3xl border border-base-300/70 bg-base-100/80 px-6 py-5">
        <div>
          <p class="text-xs uppercase tracking-[0.4em] text-base-content/60">Want more depth?</p>
          <p class="text-sm text-base-content/80">Browse the full archive of platform rebuilds, automations, and experiments.</p>
        </div>
        <a href="/work" class="btn btn-ghost border-2 border-base-300/80 hover:border-primary/60">
          Explore all work
        </a>
      </div>
    </div>
  </section>

  {recentNotes.length > 0 && (
    <section class="py-24">
      <div class="max-w-6xl mx-auto px-6 space-y-14">
        <div class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
          <div class="space-y-3">
            <p class="text-xs uppercase tracking-[0.4em] text-base-content/60">Signals</p>
            <h2 class="text-3xl sm:text-4xl font-semibold tracking-tight">Recent updates</h2>
            <p class="max-w-xl text-sm text-base-content/80">
              Field notes on automation experiments, AI-assisted delivery, and the tooling that keeps teams aligned.
            </p>
          </div>
          <a href="/background" class="btn btn-outline border-2 border-base-300/80 hover:border-primary/60">More about my work</a>
        </div>

        <div class="grid gap-6 md:grid-cols-3">
          {recentNotes.map((note) => (
            <a
              href={`/notes/${note.slug}`}
              class="group flex h-full flex-col justify-between rounded-3xl border border-base-300/80 bg-base-100/80 px-6 py-6 text-left shadow-sm transition-all duration-200 hover:-translate-y-1 hover:shadow-brutal focus:outline-none focus-visible:ring-4 focus-visible:ring-primary/40"
            >
              <div class="space-y-3">
                <p class="text-xs uppercase tracking-[0.4em] text-base-content/60">
                  {new Date(note.data.publishDate).toLocaleDateString()}
                </p>
                <h3 class="text-lg font-semibold leading-snug tracking-tight text-base-content group-hover:text-primary">
                  {note.data.title}
                </h3>
                <p class="text-sm leading-relaxed text-base-content/80">{note.data.description}</p>
              </div>
              <div class="mt-6 flex flex-wrap gap-2 text-xs text-base-content/70">
                {note.data.tags.slice(0, 3).map((tag: string) => (
                  <span class="badge badge-ghost badge-sm uppercase tracking-wide">{tag}</span>
                ))}
                {note.data.tags.length > 3 && (
                  <span class="badge badge-outline badge-sm uppercase tracking-wide">
                    +{note.data.tags.length - 3}
                  </span>
                )}
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}
</BaseLayout>
